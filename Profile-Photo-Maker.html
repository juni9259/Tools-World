<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person Remove from Photo - Easy WebTool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .input-section, .preview-section {
            margin: 20px 0;
        }
        .file-input {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 15px 30px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .file-label:hover {
            background-color: #0056b3;
        }
        .remove-btn {
            padding: 15px 30px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 15px;
        }
        .remove-btn:hover {
            background-color: #218838;
        }
        .remove-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .preview-section canvas {
            max-width: 100%;
            max-height: 300px;
            margin-top: 20px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: crosshair;
        }
        .error {
            color: #dc3545;
            margin-top: 10px;
            font-size: 16px;
        }
        .loading {
            color: #007bff;
            margin-top: 10px;
            font-size: 16px;
        }
        .download-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 15px 30px;
            background-color: #17a2b8;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .download-btn:hover {
            background-color: #138496;
        }
        .instructions {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            .file-label, .remove-btn, .download-btn {
                font-size: 18px;
                padding: 12px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Person Remove from Photo</h1>
        <div class="input-section">
            <input type="file" id="imageInput" class="file-input" accept="image/*">
            <label for="imageInput" class="file-label">Select Image</label>
            <p class="instructions">Click and drag on the image to select the area to remove.</p>
            <button class="remove-btn" id="removeBtn" disabled>Remove Person</button>
            <p id="status" class="loading" style="display: none;">Processing image...</p>
            <p id="error" class="error" style="display: none;"></p>
        </div>
        <div class="preview-section">
            <canvas id="previewCanvas" style="display: none;"></canvas>
            <a id="downloadLink" class="download-btn" style="display: none;" download="person_removed_photo.png">Download Edited Photo</a>
        </div>
    </div>
    <script>
        const imageInput = document.getElementById('imageInput');
        const removeBtn = document.getElementById('removeBtn');
        const status = document.getElementById('status');
        const error = document.getElementById('error');
        const previewCanvas = document.getElementById('previewCanvas');
        const downloadLink = document.getElementById('downloadLink');
        const ctx = previewCanvas.getContext('2d');

        let originalImage = null;
        let isSelecting = false;
        let startX, startY, endX, endY;

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showError('Please upload a valid image file (e.g., PNG, JPG).');
                    removeBtn.disabled = true;
                    return;
                }
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showError('File size exceeds 5MB.');
                    removeBtn.disabled = true;
                    return;
                }
                error.style.display = 'none';
                removeBtn.disabled = false;
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImage = new Image();
                    originalImage.src = e.target.result;
                    originalImage.onload = () => {
                        const maxSize = 600;
                        let width = originalImage.width;
                        let height = originalImage.height;
                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }
                        previewCanvas.width = width;
                        previewCanvas.height = height;
                        ctx.drawImage(originalImage, 0, 0, width, height);
                        previewCanvas.style.display = 'block';
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        previewCanvas.addEventListener('mousedown', (e) => {
            if (!originalImage) return;
            isSelecting = true;
            const rect = previewCanvas.getBoundingClientRect();
            startX = (e.clientX - rect.left) * (previewCanvas.width / rect.width);
            startY = (e.clientY - rect.top) * (previewCanvas.height / rect.height);
        });

        previewCanvas.addEventListener('mousemove', (e) => {
            if (!isSelecting) return;
            const rect = previewCanvas.getBoundingClientRect();
            endX = (e.clientX - rect.left) * (previewCanvas.width / rect.width);
            endY = (e.clientY - rect.top) * (previewCanvas.height / rect.height);

            ctx.drawImage(originalImage, 0, 0, previewCanvas.width, previewCanvas.height);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                Math.min(startX, endX),
                Math.min(startY, endY),
                Math.abs(endX - startX),
                Math.abs(endY - startY)
            );
        });

        previewCanvas.addEventListener('mouseup', () => {
            isSelecting = false;
        });

        previewCanvas.addEventListener('touchstart', (e) => {
            if (!originalImage) return;
            isSelecting = true;
            const rect = previewCanvas.getBoundingClientRect();
            startX = (e.touches[0].clientX - rect.left) * (previewCanvas.width / rect.width);
            startY = (e.touches[0].clientY - rect.top) * (previewCanvas.height / rect.height);
            e.preventDefault();
        });

        previewCanvas.addEventListener('touchmove', (e) => {
            if (!isSelecting) return;
            const rect = previewCanvas.getBoundingClientRect();
            endX = (e.touches[0].clientX - rect.left) * (previewCanvas.width / rect.width);
            endY = (e.touches[0].clientY - rect.top) * (previewCanvas.height / rect.height);

            ctx.drawImage(originalImage, 0, 0, previewCanvas.width, previewCanvas.height);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                Math.min(startX, endX),
                Math.min(startY, endY),
                Math.abs(endX - startX),
                Math.abs(endY - startY)
            );
            e.preventDefault();
        });

        previewCanvas.addEventListener('touchend', () => {
            isSelecting = false;
        });

        removeBtn.addEventListener('click', () => {
            if (!originalImage) {
                showError('Please upload an image first.');
                return;
            }
            if (!startX || !endX || !startY || !endY) {
                showError('Please select an area to remove.');
                return;
            }
            status.style.display = 'block';
            removeBtn.disabled = true;
            error.style.display = 'none';
            downloadLink.style.display = 'none';

            const worker = new Worker(URL.createObjectURL(new Blob([`
                self.onmessage = function(e) {
                    const { imageData, x, y, w, h, width, height } = e.data;
                    const data = imageData.data;

                    // Improved inpainting: blend with surrounding pixels using a weighted average
                    for (let py = y; py < y + h; py++) {
                        for (let px = x; px < x + w; px++) {
                            let r = 0, g = 0, b = 0, weightSum = 0;
                            for (let i = -3; i <= 3; i++) {
                                for (let j = -3; j <= 3; j++) {
                                    const nx = px + i;
                                    const ny = py + j;
                                    if (nx < x || nx >= x + w || ny < y || ny >= y + h) {
                                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                            const idx = (ny * width + nx) * 4;
                                            const weight = 1 / (1 + Math.sqrt(i * i + j * j));
                                            r += data[idx] * weight;
                                            g += data[idx + 1] * weight;
                                            b += data[idx + 2] * weight;
                                            weightSum += weight;
                                        }
                                    }
                                }
                            }
                            const idx = (py * width + px) * 4;
                            data[idx] = Math.round(r / weightSum);
                            data[idx + 1] = Math.round(g / weightSum);
                            data[idx + 2] = Math.round(b / weightSum);
                            data[idx + 3] = 255;
                        }
                    }

                    self.postMessage({ imageData });
                };
            `], { type: 'application/javascript' })));

            const x = Math.floor(Math.min(startX, endX));
            const y = Math.floor(Math.min(startY, endY));
            const w = Math.floor(Math.abs(endX - startX));
            const h = Math.floor(Math.abs(endY - startY));
            const imageData = ctx.getImageData(0, 0, previewCanvas.width, previewCanvas.height);

            worker.onmessage = (e) => {
                ctx.putImageData(e.data.imageData, 0, 0);
                const dataUrl = previewCanvas.toDataURL('image/png');
                downloadLink.href = dataUrl;
                downloadLink.style.display = 'inline-block';
                // Force download by creating a temporary link
                downloadLink.onclick = () => {
                    const tempLink = document.createElement('a');
                    tempLink.href = dataUrl;
                    tempLink.download = 'person_removed_photo.png';
                    document.body.appendChild(tempLink);
                    tempLink.click();
                    document.body.removeChild(tempLink);
                };
                status.style.display = 'none';
                removeBtn.disabled = false;
                worker.terminate();
            };

            worker.postMessage({
                imageData,
                x,
                y,
                w,
                h,
                width: previewCanvas.width,
                height: previewCanvas.height
            });
        });

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            previewCanvas.style.display = 'none';
            downloadLink.style.display = 'none';
        }
    </script>
</body>
</html>
